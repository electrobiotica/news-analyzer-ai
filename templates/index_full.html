<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="title">Alineador Pol√≠tico</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body {
      background: #f3f4f6;
      color: #1f2937;
      transition: background .2s, color .2s;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    body.dark {
      background: #111827;
      color: #f9fafb;
    }

    .card {
      background: #ffffff;
      color: #1f2937;
      transition: background .2s, color .2s;
    }

    body.dark .card {
      background: #1f2937;
      color: #f9fafb;
    }

    .tag {
      display: inline-block;
      background: #e5e7eb;
      padding: 2px 8px;
      margin: 2px;
      border-radius: 12px;
      font-size: 12px;
    }

    body.dark .tag {
      background: #374151;
      color: #f3f4f6;
    }

    .resaltado {
      background: yellow;
      font-weight: bold;
    }

    body.dark .resaltado {
      background: #facc15;
      color: #111827;
    }

    .switch {
      cursor: pointer;
    }

    body.dark input[type="text"],
    body.dark textarea,
    body.dark select {
      background: #374151;
      color: #f9fafb;
      border-color: #4b5563;
    }

    body.dark input::placeholder {
      color: #9ca3af;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      text-align: center;
      background: #f3f4f6;
      color: #6b7280;
      padding: 10px;
      font-size: 14px;
      z-index: 50;
    }

    body.dark footer {
      background: #111827;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <main class="flex-1 flex items-center justify-center px-4 pb-24">
    <div class="w-full max-w-2xl card rounded-2xl shadow-xl p-8 space-y-6">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-semibold" data-i18n="title">üß≠ Alineador Pol√≠tico</h1>
        <div class="flex gap-2">
          <button id="btnDark" class="text-sm px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 switch" title="Dark/Light">üåô</button>
          <button id="btnLang" class="text-sm px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 switch" title="ES/EN">üåê</button>
        </div>
      </div>

      <div class="space-y-2">
        <input id="url" type="text" placeholder="https://ejemplo.com" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none" />
        <button id="btnAnalizar" class="w-full bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700 transition" data-i18n="analyze">Analizar</button>
      </div>

      <div id="resultado" class="hidden space-y-6">
        <div id="reporte">
          <h2 class="text-lg font-medium" data-i18n="detected">üîç Alineaci√≥n pol√≠tica detectada</h2>
          <div class="flex flex-col gap-3">
            <div>
              <p data-i18n="left">Izquierda</p>
              <div class="w-full bg-gray-300 rounded-full h-4">
                <div id="barraIzquierda" class="bg-red-500 h-4 rounded-full" style="width:0%"></div>
              </div>
            </div>
            <div>
              <p data-i18n="right">Derecha</p>
              <div class="w-full bg-gray-300 rounded-full h-4">
                <div id="barraDerecha" class="bg-blue-500 h-4 rounded-full" style="width:0%"></div>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h3 class="text-md font-medium mb-1" data-i18n="justif">üìÑ Justificaci√≥n</h3>
            <p id="justificacion" class="text-sm whitespace-pre-wrap italic"></p>
          </div>

          <div class="mt-4">
            <h3 class="text-md font-medium mb-1" data-i18n="keywords">üìå Palabras clave</h3>
            <div id="keywords" class="text-sm"></div>
          </div>

          <div class="mt-4">
            <h3 class="text-md font-medium mb-1" data-i18n="biased">‚ö†Ô∏è Frases sesgadas</h3>
            <ul id="sesgadas" class="text-sm list-disc pl-5"></ul>
          </div>
        </div>

        <div class="flex gap-2 flex-wrap">
          <button id="btnPDF" class="bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700" data-i18n="pdf">üìÑ Exportar PDF</button>
          <button id="btnJSON" class="bg-gray-600 text-white px-4 py-2 rounded-xl hover:bg-gray-700" data-i18n="json">‚¨áÔ∏è Descargar JSON</button>
        </div>
      </div>
    </div>
  </main>

  <footer>
    ¬© 2025 Alineador Pol√≠tico ‚Ä¢ Hecho con üß† y üß≠
  </footer>

  <script>
    let LANG = localStorage.getItem("lang") || (navigator.language.startsWith("es") ? "es" : "en");
    let DARK = localStorage.getItem("dark") === "true";
    let lastData = null;
    let lastUrl  = null;

    const STR = {
      es: { title:"üß≠ Alineador Pol√≠tico", analyze:"Analizar", detected:"üîç Alineaci√≥n pol√≠tica detectada",
            left:"Izquierda", right:"Derecha", justif:"üìÑ Justificaci√≥n", keywords:"üìå Palabras clave",
            biased:"‚ö†Ô∏è Frases sesgadas", pdf:"üìÑ Exportar PDF", json:"‚¨áÔ∏è Descargar JSON",
            analyzing:"Analizando...", invalid_url:"Por favor ingresa una URL v√°lida", error:"Error" },
      en: { title:"üß≠ Political Alignment Analyzer", analyze:"Analyze", detected:"üîç Detected political alignment",
            left:"Left", right:"Right", justif:"üìÑ Justification", keywords:"üìå Keywords",
            biased:"‚ö†Ô∏è Biased phrases", pdf:"üìÑ Export PDF", json:"‚¨áÔ∏è Download JSON",
            analyzing:"Analyzing...", invalid_url:"Please enter a valid URL", error:"Error" }
    };

    function applyLang() {
      document.documentElement.lang = LANG;
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (STR[LANG][key]) el.textContent = STR[LANG][key];
      });
      document.getElementById("url").placeholder = LANG === "es" ? "https://ejemplo.com" : "https://example.com";
    }

    function cambiarIdioma() {
      LANG = LANG === "es" ? "en" : "es";
      localStorage.setItem("lang", LANG);
      applyLang();
      if (lastData) pintarResultado(lastData);
    }

    function applyDark() {
      if (DARK) document.body.classList.add("dark");
      else document.body.classList.remove("dark");
      localStorage.setItem("dark", DARK);
    }

    function toggleModoOscuro() {
      DARK = !DARK;
      applyDark();
    }

    function pickLang(value){
      if (typeof value === "string") return value;
      if (Array.isArray(value)) return value;
      if (value && typeof value === "object"){
        return value[LANG] ?? value.es ?? value.en ?? Object.values(value)[0];
      }
      return "";
    }

    function toArray(v){
      if (Array.isArray(v)) return v;
      if (!v || v === "") return [];
      return [v];
    }

    async function analizar() {
      const url = document.getElementById("url").value.trim();
      if (!url) return alert(STR[LANG].invalid_url);

      lastUrl = url;
      document.getElementById("resultado").classList.remove("hidden");
      document.getElementById("justificacion").innerText = STR[LANG].analyzing;

      try {
        const res = await fetch("/analizar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        lastData = data;
        pintarResultado(data);
      } catch (e) {
        document.getElementById("justificacion").innerText = STR[LANG].error + ": " + e.message;
      }
    }

    function pintarResultado(data){
      document.getElementById("barraIzquierda").style.width = data.alineacion.izquierda + "%";
      document.getElementById("barraDerecha").style.width   = data.alineacion.derecha   + "%";

      const justif = pickLang(data.justificacion) || "";
      const frases = toArray(pickLang(data.frases_sesgadas));
      const keys   = toArray(pickLang(data.keywords));

      let justifHTML = justif;
      frases.forEach(f => {
        if (!f) return;
        const safe = f.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        justifHTML = justifHTML.replace(new RegExp(safe, "g"), `<span class='resaltado'>${f}</span>`);
      });
      document.getElementById("justificacion").innerHTML = justifHTML;

      document.getElementById("keywords").innerHTML =
        keys.map(k => `<span class="tag">${k}</span>`).join(" ");

      document.getElementById("sesgadas").innerHTML =
        frases.map(f => `<li>${f}</li>`).join("");

      applyLang();
    }

    async function exportarPDF() {
      const idioma = LANG;
      const section = document.getElementById("resultado");
      if (!section) return;

      const clone = section.cloneNode(true);
      clone.style.background = "white";
      clone.style.color = "black";
      clone.style.padding = "20px";
      clone.style.fontSize = "14px";

      const tempDiv = document.createElement("div");
      tempDiv.appendChild(clone);
      tempDiv.style.position = "fixed";
      tempDiv.style.top = "-10000px";
      document.body.appendChild(tempDiv);

      try {
        await html2pdf()
          .from(clone)
          .set({
            margin: 0.5,
            filename: `analisis_politico_${idioma}.pdf`,
            html2canvas: { scale: 2 },
            jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
          })
          .save();
      } catch (e) {
        console.error("‚ùå Error al exportar PDF:", e);
      }

      document.body.removeChild(tempDiv);
    }

    function exportarJSON() {
      if (!lastData) return;
      const blob = new Blob([JSON.stringify(lastData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `analisis_${LANG}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("btnAnalizar").addEventListener("click", analizar);
    document.getElementById("btnPDF").addEventListener("click", exportarPDF);
    document.getElementById("btnJSON").addEventListener("click", exportarJSON);
    document.getElementById("btnDark").addEventListener("click", toggleModoOscuro);
    document.getElementById("btnLang").addEventListener("click", cambiarIdioma);

    applyDark();
    applyLang();
  </script>
</body>
</html>
